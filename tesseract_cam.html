<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Interstellar Flickr Grid</title>
  <style>
    :root{
      --bg: #000;
      --fg: rgba(255,255,255,.85);
      --dim: rgba(255,255,255,.55);

      --cols: 14;
      --rows: 8;

      --gap: 10px;

      /* 3D stage */
      --persp: 900px;
      --tiltX: 62deg;   /* Interstellar-ish shelf angle */
      --tiltY: -18deg;
      --spinZ: 18deg;

      /* cell */
      --cell-radius: 14px;
      --cell-border: rgba(255,255,255,.14);

      /* animation */
      --pulse: 0.0;
    }

    html, body {
      margin:0; height:100%;
      background: var(--bg);
      overflow:hidden;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: var(--fg);
    }

    /* subtle film grain */
    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background-image:
        repeating-linear-gradient(0deg, rgba(255,255,255,.03) 0 1px, rgba(0,0,0,0) 1px 3px),
        repeating-linear-gradient(90deg, rgba(255,255,255,.02) 0 1px, rgba(0,0,0,0) 1px 4px);
      mix-blend-mode: overlay;
      opacity: .22;
    }

    #hud{
      position:fixed; left:14px; top:14px; z-index:20;
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 10px 12px;
      user-select:none;
      min-width: 320px;
      backdrop-filter: blur(6px);
    }
    #hud .title{ font-weight:700; }
    #hud .row{ margin-top:6px; font-size:12px; line-height:1.4; color: var(--dim); }
    #hud input{
      width: 250px;
      padding: 7px 9px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: var(--fg);
      outline:none;
      margin-left: 8px;
      font: inherit;
    }
    #hud button{
      margin-left: 8px;
      padding: 7px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: var(--fg);
      cursor:pointer;
      font: inherit;
    }
    #hud button:hover{ background: rgba(255,255,255,.12); }
    #hud .k { color: rgba(255,255,255,.85); font-weight:700; }

    #stage{
      position:fixed; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      perspective: var(--persp);
      transform-style: preserve-3d;
    }

    /* The "lattice" plane */
    #lattice{
      position:relative;
      width: min(1400px, 94vw);
      height: min(820px, 84vh);
      transform-style: preserve-3d;
      will-change: transform;
      transform:
        rotateX(var(--tiltX))
        rotateY(var(--tiltY))
        rotateZ(var(--spinZ));
      filter: drop-shadow(0 30px 60px rgba(0,0,0,.55));
    }

    /* Grid lines overlay */
    #lattice::before{
      content:"";
      position:absolute; inset:-4px;
      pointer-events:none;
      background:
        repeating-linear-gradient(
          0deg,
          rgba(255,255,255,.08) 0px,
          rgba(255,255,255,.08) 1px,
          rgba(0,0,0,0) 1px,
          rgba(0,0,0,0) calc((100% / var(--rows)) - 0px)
        ),
        repeating-linear-gradient(
          90deg,
          rgba(255,255,255,.07) 0px,
          rgba(255,255,255,.07) 1px,
          rgba(0,0,0,0) 1px,
          rgba(0,0,0,0) calc((100% / var(--cols)) - 0px)
        );
      opacity: .35;
      mix-blend-mode: screen;
      border-radius: 22px;
      mask-image: radial-gradient(circle at 50% 50%, black 40%, transparent 78%);
    }

    /* Actual grid container */
    #grid{
      position:absolute; inset:0;
      display:grid;
      grid-template-columns: repeat(var(--cols), 1fr);
      grid-template-rows: repeat(var(--rows), 1fr);
      gap: var(--gap);
      padding: 14px;
      transform-style: preserve-3d;
    }

    .cell{
      position:relative;
      border-radius: var(--cell-radius);
      border: 1px solid var(--cell-border);
      overflow:hidden;
      background: rgba(255,255,255,.03);
      transform-style: preserve-3d;
      will-change: transform, opacity;
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.05),
        0 10px 26px rgba(0,0,0,.35);
    }

    /* Depth: each cell slightly lifted and wobbled */
    .cell{
      transform: translateZ(var(--z, 0px)) rotateX(var(--rx, 0deg)) rotateY(var(--ry, 0deg));
      opacity: var(--op, .88);
    }

    .cell::after{
      /* glass highlight */
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,.22), rgba(255,255,255,0) 55%);
      opacity: .32;
      mix-blend-mode: screen;
      pointer-events:none;
    }

    img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
      transform: scale(1.02);
      filter: contrast(1.05) saturate(1.08);
      opacity: var(--imgop, 1);
      transition: opacity 900ms ease;
    }

    .fadeIn img{ opacity: 1; }
    .fadeOut img{ opacity: .08; }

    /* bottom vignette */
    #vignette{
      position:fixed; inset:0;
      pointer-events:none;
      background: radial-gradient(circle at 50% 45%, rgba(0,0,0,0) 0 45%, rgba(0,0,0,.6) 75%, rgba(0,0,0,.92) 100%);
      opacity: .85;
      z-index: 10;
    }

    #toast{
      position:fixed;
      left:50%; bottom:14px; transform:translateX(-50%);
      padding: 10px 14px;
      background: rgba(0,0,0,.6);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 14px;
      color: var(--fg);
      font-size: 12px;
      z-index: 30;
      opacity:0;
      transition: opacity .18s ease;
      pointer-events:none;
      max-width: 86vw;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    #toast.show{ opacity:1; }
  </style>
</head>
<body>

  <div id="hud">
    <div class="title">Interstellar Flickr Grid</div>
    <div class="row">
      Tags:
      <input id="tags" value="space,nebula,night" />
      <button id="apply">Apply</button>
      <button id="pause">Pause</button>
    </div>
    <div class="row">
      Status: <span id="status">init…</span>
      <span style="margin-left:10px;">Loaded: <span id="loaded">0</span></span>
      <span style="margin-left:10px;">Pool: <span id="pool">0</span></span>
    </div>
    <div class="row">
      Keys: <span class="k">H</span> HUD / <span class="k">R</span> Reload feed / <span class="k">Space</span> Pause
    </div>
  </div>

  <div id="stage">
    <div id="lattice">
      <div id="grid"></div>
    </div>
  </div>

  <div id="vignette"></div>
  <div id="toast"></div>

<script>
(() => {
  const $ = (sel) => document.querySelector(sel);
  const grid = $("#grid");
  const hud = $("#hud");
  const statusEl = $("#status");
  const loadedEl = $("#loaded");
  const poolEl = $("#pool");
  const tagsInput = $("#tags");
  const applyBtn = $("#apply");
  const pauseBtn = $("#pause");
  const toastEl = $("#toast");

  const COLS = 14;
  const ROWS = 8;
  const CELLS = COLS * ROWS;

  let paused = false;
  let currentTags = tagsInput.value.trim() || "space,nebula,night";

  // Pool of image URLs
  let urlPool = [];
  let loadedCount = 0;

  // Timing
  const INTERVAL_MS = 4000;
  let lastTick = performance.now();

  function setStatus(s){ statusEl.textContent = s; }
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(() => toastEl.classList.remove("show"), 1200);
  }
  function updateCounters(){
    loadedEl.textContent = String(loadedCount);
    poolEl.textContent = String(urlPool.length);
  }

  // --- Create cells
  const cells = [];
  for (let i=0; i<CELLS; i++){
    const cell = document.createElement("div");
    cell.className = "cell";

    // Depth styling (Interstellar-ish)
    const x = i % COLS;
    const y = Math.floor(i / COLS);

    // Depth gradient: center forward, edges back
    const nx = (x/(COLS-1))*2 - 1;
    const ny = (y/(ROWS-1))*2 - 1;
    const r = Math.sqrt(nx*nx + ny*ny);

    const z = (1 - r) * 60 + (Math.random()*14 - 7);     // px
    const rx = (Math.random()*2 - 1) * 2.5;              // deg
    const ry = (Math.random()*2 - 1) * 2.5;

    cell.style.setProperty("--z", `${z.toFixed(1)}px`);
    cell.style.setProperty("--rx", `${rx.toFixed(2)}deg`);
    cell.style.setProperty("--ry", `${ry.toFixed(2)}deg`);
    cell.style.setProperty("--op", `${(0.68 + (1-r)*0.28).toFixed(2)}`);

    const img = document.createElement("img");
    img.alt = "flickr";
    img.decoding = "async";
    img.loading = "lazy";
    img.style.opacity = "0";
    cell.appendChild(img);

    grid.appendChild(cell);
    cells.push(cell);
  }

  // --- Flickr Public Feed (JSONP, no API key)
  // We request: https://www.flickr.com/services/feeds/photos_public.gne?format=json&tags=...&tagmode=all&lang=en-us&jsoncallback=CALLBACK
  function flickrFeed(tags){
    return new Promise((resolve, reject) => {
      const cb = "__flickr_cb_" + Date.now() + "_" + Math.random().toString(16).slice(2);
      const script = document.createElement("script");

      let timeout = setTimeout(() => {
        cleanup();
        reject(new Error("Flickr feed timeout"));
      }, 9000);

      function cleanup(){
        clearTimeout(timeout);
        delete window[cb];
        script.remove();
      }

      window[cb] = (data) => {
        cleanup();
        try{
          const items = (data && data.items) ? data.items : [];
          // items[i].media.m is typically _m.jpg (small). Try to swap to a bigger size when possible.
          const urls = items.map(it => {
            const u = it?.media?.m;
            if (!u) return null;
            // Try larger: _m -> _b or _c (not always valid, but often works)
            // We'll try _b first; if that fails onload, browser will show broken image in that cell only (rare).
            return u.replace("_m.", "_b.");
          }).filter(Boolean);

          resolve(urls);
        } catch (e){
          reject(e);
        }
      };

      const src =
        "https://www.flickr.com/services/feeds/photos_public.gne" +
        "?format=json" +
        "&lang=en-us" +
        "&tagmode=all" +
        "&tags=" + encodeURIComponent(tags) +
        "&jsoncallback=" + encodeURIComponent(cb) +
        "&_=" + Date.now(); // cache bust

      script.src = src;
      script.onerror = () => {
        cleanup();
        reject(new Error("Flickr feed script error"));
      };

      document.head.appendChild(script);
    });
  }

  async function refillPool(){
    setStatus("fetching flickr feed…");
    try{
      const urls = await flickrFeed(currentTags);
      // Shuffle for variety
      for (let i = urls.length - 1; i > 0; i--){
        const j = (Math.random() * (i+1)) | 0;
        [urls[i], urls[j]] = [urls[j], urls[i]];
      }
      // Merge (keep size bounded)
      urlPool = urls.concat(urlPool).slice(0, 400);
      setStatus(`ok (${urls.length} items)`);
      updateCounters();
      toast(`Feed loaded: ${urls.length} photos`);
    } catch (e){
      setStatus("feed failed (retrying soon)");
      toast("Feed failed. Check network.");
      // Keep running; we'll retry later
    }
  }

  // --- Assign an image to a random cell with gentle transition
  function injectOne(){
    if (urlPool.length === 0) return;
    const url = urlPool.pop();
    const idx = (Math.random() * cells.length) | 0;
    const cell = cells[idx];
    const img = cell.querySelector("img");

    // fade out old
    cell.classList.remove("fadeIn");
    cell.classList.add("fadeOut");

    // swap after short delay to allow fade
    setTimeout(() => {
      img.style.opacity = "0";
      img.onload = () => {
        loadedCount++;
        updateCounters();
        cell.classList.remove("fadeOut");
        cell.classList.add("fadeIn");
        img.style.opacity = "1";
      };
      img.onerror = () => {
        // If larger size fails, fall back to original _m
        const fallback = url.replace("_b.", "_m.");
        if (img.src !== fallback){
          img.src = fallback;
          return;
        }
        // If still fails, drop silently
      };
      img.src = url;
    }, 220);
  }

  // --- Initial fill
  async function init(){
    document.documentElement.style.setProperty("--cols", COLS);
    document.documentElement.style.setProperty("--rows", ROWS);

    await refillPool();

    // Seed a bunch quickly
    for (let i=0; i<Math.min(40, CELLS); i++){
      injectOne();
    }

    setStatus("running");
    updateCounters();
  }

  // --- 3D camera-ish mouse parallax
  let mx = 0, my = 0;
  let tx = 0, ty = 0;
  const lattice = $("#lattice");

  window.addEventListener("pointermove", (e) => {
    mx = (e.clientX / innerWidth) * 2 - 1;
    my = (e.clientY / innerHeight) * 2 - 1;
  });

  function animate(){
    requestAnimationFrame(animate);

    // smoothing
    tx += (mx - tx) * 0.06;
    ty += (my - ty) * 0.06;

    // parallax transform (subtle, cinematic)
    const rx = 62 + ty * 3.5;
    const ry = -18 + tx * 6.0;
    const rz = 18 + tx * 1.5;

    lattice.style.transform =
      `rotateX(${rx}deg) rotateY(${ry}deg) rotateZ(${rz}deg) translateZ(0px)`;

    // tick inject
    const now = performance.now();
    if (!paused && now - lastTick > INTERVAL_MS){
      lastTick = now;

      // If pool is running low, refill in background
      if (urlPool.length < 24) refillPool();

      // Inject a few per tick for living lattice
      injectOne();
      if (Math.random() < 0.55) injectOne();
    }
  }

  // --- Controls
  applyBtn.onclick = async () => {
    currentTags = tagsInput.value.trim() || "space,nebula,night";
    toast("Tags applied: " + currentTags);
    urlPool = [];
    await refillPool();
  };

  function togglePause(){
    paused = !paused;
    pauseBtn.textContent = paused ? "Resume" : "Pause";
    toast(paused ? "Paused" : "Resumed");
  }

  pauseBtn.onclick = togglePause;

  window.addEventListener("keydown", (e) => {
    if (e.key.toLowerCase() === "h"){
      hud.style.display = (hud.style.display === "none") ? "block" : "none";
      toast(hud.style.display === "none" ? "HUD hidden" : "HUD shown");
    }
    if (e.key.toLowerCase() === "r"){
      refillPool();
      toast("Reloading feed…");
    }
    if (e.code === "Space"){
      e.preventDefault();
      togglePause();
    }
  }, { passive:false });

  // Start
  init().then(animate);
})();
</script>
</body>
</html>
